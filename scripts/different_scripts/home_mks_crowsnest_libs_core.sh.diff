--- /media/mks/5dcae443-0796-4029-ae6c-bf5bd2a37067/home/mks/crowsnest/libs/core.sh	2023-12-15 01:50:44.406398135 -0500
+++ /media/mks/armbi_root/home/mks/crowsnest/libs/core.sh	2024-08-07 08:44:43.325744626 -0400
@@ -33,8 +33,14 @@
 # Print Error Code and Line to Log
 # and kill running jobs
 function err_exit {
+    local file_trace func_trace line_trace
+    read -r LINE FUNC FILE < <(caller 0)
+    func_trace="${FUNC}"
+    file_trace="$(basename "${FILE}")"
+    line_trace="${LINE}"
     if [ "${1}" != "0" ]; then
-        log_msg "ERROR: Error ${1} occured on line ${2}"
+        log_msg "ERROR: Error ${1} occured on line ${line_trace}"
+        log_msg "==> Error occured in file: ${file_trace} -> ${func_trace}"
         log_msg "ERROR: Stopping $(basename "$0")."
         log_msg "Goodbye..."
     fi
@@ -66,7 +72,7 @@
 function check_dep {
     local dep
     dep="$(whereis "${1}" | awk '{print $2}')"
-    if [ -z "${dep}" ]; then
+    if [[ -z "${dep}" ]]; then
         log_msg "Dependency: '${1}' not found. Exiting!"
         exit 1
     else
@@ -75,30 +81,29 @@
 }
 
 function check_apps {
-    local paths
-    paths=(
-        bin/ustreamer/ustreamer
-        bin/rtsp-simple-server/rtsp-simple-server
-        )
-    for chk in "${paths[@]}"; do
-        if [ -x "${BASE_CN_PATH}/${chk}" ]; then
-            log_msg "Dependency: '$(echo "${chk}" | cut -d '/' -f3)' found in ${chk}."
+    local cstreamer ustreamer
+    ustreamer="bin/ustreamer/src/ustreamer.bin"
+    cstreamer="bin/camera-streamer/camera-streamer"
+    if [[ -x "${BASE_CN_PATH}/${ustreamer}" ]]; then
+        log_msg "Dependency: 'ustreamer' found in ${ustreamer}."
+        UST_BIN="${BASE_CN_PATH}/${ustreamer}"
+        # shellcheck disable=SC2034
+        declare -r UST_BIN
+    else
+        log_msg "Dependency: 'ustreamer' not found. Exiting!"
+        exit 1
+    fi
+
+    ## Avoid dependency check if non rpi sbc
+    if [[ "$(is_raspberry_pi)" = "1" ]] &&
+    [[ "$(is_ubuntu_arm)" = "0" ]] &&
+    [[ "$(is_pi5)" = "0" ]]; then
+        if [[ -x "${BASE_CN_PATH}/${cstreamer}" ]]; then
+            log_msg "Dependency: '${cstreamer##*/}' found in ${cstreamer}."
         else
-            log_msg "Dependency: '$(echo "${chk}" | cut -d '/' -f3)' not found. Exiting!"
+            log_msg "Dependency: '${cstreamer##*/}' not found. Exiting!"
             exit 1
         fi
-    done
-}
-
-# checks availability of OpenMax IL feature on host and in apps.
-# 0 = false / 1 = true
-function check_omx {
-    if [ -d "/opt/vc/include" ] &&
-    [ ! "$(ffmpeg -hide_banner -buildconf | grep -c 'omx')" = "0" ] &&
-    [ "$("${BASE_CN_PATH}"/bin/ustreamer/ustreamer --features | grep -c '\+ WITH_OMX')" = "1" ]; then
-        echo "1"
-    else
-        echo "0"
     fi
 }
 
@@ -107,12 +112,10 @@
 # print_cfg, see libs/logging.sh L#75
 # pint_cams, see libs/logging.sh L#84
 function initial_check {
-    log_msg "INFO: Checking Dependencys"
+    log_msg "INFO: Checking Dependencies"
     check_dep "crudini"
     check_dep "find"
-    check_dep "logger"
     check_dep "xargs"
-    check_dep "ffmpeg"
     check_apps
     versioncontrol
     # print cfg if ! "${CROWSNEST_LOG_LEVEL}": quiet
@@ -121,8 +124,7 @@
             print_cfg
         fi
     fi
-    # in systemd show always config file
-    logger -t crowsnest -f "${CROWSNEST_CFG}"
     log_msg "INFO: Detect available Devices"
     print_cams
+    return
 }

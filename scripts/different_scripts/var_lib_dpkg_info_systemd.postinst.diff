--- /media/mks/5dcae443-0796-4029-ae6c-bf5bd2a37067/var/lib/dpkg/info/systemd.postinst	2021-07-08 09:03:45.000000000 -0400
+++ /media/mks/armbi_root/var/lib/dpkg/info/systemd.postinst	2024-06-16 05:44:31.000000000 -0400
@@ -1,27 +1,38 @@
-#! /bin/sh
+#!/bin/sh
 
 set -e
 
 _systemctl() {
-    if [ -d /run/systemd/system ]; then
+    if [ -z "$DPKG_ROOT" ] && [ -d /run/systemd/system ]; then
         systemctl "$@"
     fi
 }
 
 _update_catalog() {
-    journalctl --update-catalog || true
+    journalctl ${DPKG_ROOT:+--root="$DPKG_ROOT"} --update-catalog || true
 }
 
-# Update Message Catalogs database and reload in response to dpkg triggers
+_update_binfmt() {
+    # If binfmt-support is installed and active do not restart
+    # systemd-binfmt.service. It will unregister all currently registered
+    # binary formats in ExecStop and not all packages with a binfmt-support
+    # configuration ship a corresponding binfmt.d snippet yet.
+    # Once this is the case, this additional safety check can be removed.
+    if ! _systemctl -q is-active binfmt-support.service; then
+        _systemctl try-restart systemd-binfmt.service || true
+    fi
+}
+
+# Update Message Catalogs database and binfmt registrations in response to dpkg triggers
 if [ "$1" = "triggered" ]; then
     shift
-    for trigger in "$@"; do
+    for trigger in $@; do
         case $trigger in
             /usr/lib/systemd/catalog)
                 _update_catalog
                 ;;
-            /etc/init.d)
-                _systemctl daemon-reload || true
+            /usr/lib/binfmt.d)
+                _update_binfmt
                 ;;
         esac
     done
@@ -30,166 +41,65 @@
 
 # Enable getty and remote-fs.target by default on new installs
 if [ -z "$2" ]; then
-    systemctl enable getty@tty1.service || true
-    systemctl enable remote-fs.target || true
-fi
-
-# Enable timesyncd by default on new installs installs and upgrades
-if dpkg --compare-versions "$2" lt "218-11~"; then
-    systemctl enable systemd-timesyncd.service || true
-fi
-
-# Enable ondemand by default on new installs installs and upgrades
-if [ -e /lib/systemd/system/ondemand.service ] && dpkg --compare-versions "$2" lt "231-7~"; then
-    systemctl enable ondemand.service || true
-fi
-
-# Do a one-time migration of the local time setting
-if [ -z "$2" ]; then
-    if [ -f /etc/default/rcS ]; then
-        . /etc/default/rcS
-    fi
-    if [ "$UTC" = "no" ] && [ ! -e /etc/adjtime ]; then
-        printf "0.0 0 0.0\n0\nLOCAL\n" > /etc/adjtime
-    fi
-fi
-
-# Do a one-time migration of the TMPTIME setting
-if [ -z "$2" ]; then
-    if [ -f /etc/default/rcS ]; then
-        . /etc/default/rcS
-    fi
-    if [ ! -e /etc/tmpfiles.d/tmp.conf ]; then
-        case "$TMPTIME" in
-            -*|infinite|infinity)
-                cat > /etc/tmpfiles.d/tmp.conf <<EOF
-# Avoid clearing /tmp by shipping an empty /etc/tmpfiles.d/tmp.conf file
-# which overrides /usr/lib/tmpfiles.d/tmp.conf.
-# This file was automatically created because of local modifications in
-# /etc/default/rcS where TMPTIME was set to infinite.
-EOF
-                ;;
-        esac
-    fi
+    systemctl ${DPKG_ROOT:+--root="$DPKG_ROOT"} enable getty@tty1.service || true
+    systemctl ${DPKG_ROOT:+--root="$DPKG_ROOT"} enable remote-fs.target || true
 fi
 
-# Do a one-time migration of the RAMTMP setting
-if [ -z "$2" ]; then
-    if [ -f /etc/default/rcS ]; then
-        . /etc/default/rcS
-    fi
-    if [ -f /etc/default/tmpfs ]; then
-        . /etc/default/tmpfs
-    fi
-    if [ "$RAMTMP" = "yes" ]; then
-        # systemctl enable will work even when systemd is not the active PID 1.
-        if [ ! -e /etc/systemd/system/tmp.mount ]; then
-            cp /usr/share/systemd/tmp.mount /etc/systemd/system/tmp.mount
-            systemctl enable tmp.mount || true
-        fi
-    fi
+# Enable systemd-pstore by default on new installs and upgrades, see #952767
+if dpkg --compare-versions "$2" lt "245.4-4~"; then
+    systemctl ${DPKG_ROOT:+--root="$DPKG_ROOT"} enable systemd-pstore.service || true
 fi
 
 # Create /etc/machine-id
-systemd-machine-id-setup
-
-# Setup system users and groups
-addgroup --quiet --system systemd-journal
-
-# We need to stop running services before we call adduser
-RESTART=""
-if dpkg --compare-versions "$2" lt-nl "239-6"; then
-    for s in systemd-networkd systemd-timesyncd systemd-resolved ; do
-        if _systemctl -q is-active $s; then
-            _systemctl stop $s
-            RESTART="$s $RESTART"
-        fi
-    done
-fi
+systemd-machine-id-setup ${DPKG_ROOT:+--root="$DPKG_ROOT"}
 
-adduser --quiet --system --group --no-create-home --home /run/systemd \
-    --gecos "systemd Time Synchronization" systemd-timesync
-adduser --quiet --system --group --no-create-home --home /run/systemd \
-    --gecos "systemd Network Management" systemd-network
-adduser --quiet --system --group --no-create-home --home /run/systemd \
-    --gecos "systemd Resolver" systemd-resolve
-
-# Remove old state directory of systemd-timesyncd
-if dpkg --compare-versions "$2" lt-nl "240-3~"; then
-    if [ -L /var/lib/systemd/timesync ] ; then
-        rm /var/lib/systemd/timesync
-        rm -rf /var/lib/private/systemd/timesync
-    fi
+# Enable persistent journal, in auto-mode, by default on new installs and upgrades
+if dpkg --compare-versions "$2" lt "244.1-2~"; then
+    mkdir -p "$DPKG_ROOT/var/log/journal"
 fi
 
 # Initial update of the Message Catalogs database
 _update_catalog
 
-if [ -n "$2" ]; then
-    _systemctl daemon-reexec || true
-    # don't restart logind; this can be done again once this gets implemented:
-    # https://github.com/systemd/systemd/issues/1163
-    _systemctl try-restart systemd-networkd.service || true
-    _systemctl try-restart systemd-resolved.service || true
-    _systemctl try-restart systemd-timesyncd.service || true
-    _systemctl try-restart systemd-journald.service || true
+if dpkg --compare-versions "$2" lt-nl "245.4-4~"; then
+    # systemd-pstore.service is now enabled via sysinit.target
+    rm -f /etc/systemd/system/systemd-remount-fs.service.wants/systemd-pstore.service
+    rmdir --ignore-fail-on-non-empty /etc/systemd/system/systemd-remount-fs.service.wants 2> /dev/null || true
 fi
 
-# Restart services which we stopped earlier
-# This needs to run after daemon-rexec
-if dpkg --compare-versions "$2" lt-nl "239-6"; then
-    for s in $RESTART ; do
-        _systemctl start $s
-    done
+if dpkg --compare-versions "$2" lt-nl "245.4-5~"; then
+    # Clean up removed ondemand service
+    rm -f /etc/systemd/system/multi-user.target.wants/ondemand.service
 fi
 
-# Cleanup hwclock-save.service, which was shipped in jessie.
-if dpkg --compare-versions "$2" lt-nl "228-5~"; then
-   for t in reboot halt poweroff ; do
-       rm -f /etc/systemd/system/${t}.target.wants/hwclock-save.service
-       rmdir --ignore-fail-on-non-empty /etc/systemd/system/${t}.target.wants 2> /dev/null || true
-   done
-fi
-
-if dpkg --compare-versions "$2" lt-nl "235-3~"; then
-    # systemd-bus-proxyd got dropped before stretch, and never created any file
-    deluser --system systemd-bus-proxy || true
-fi
-
-if dpkg --compare-versions "$2" lt-nl "236-1~"; then
-    # Clean up old /var/lib/systemd/clock on upgrade.
-    # The clock file used by systemd-timesyncd is now stored in
-    # StateDirectory=systemd/timesync.
-    rm -f /var/lib/systemd/clock
-fi
-
-if dpkg --compare-versions "$2" lt-nl "239-12~"; then
-    # clean up bogus "nobody" group from #912525; ensure that it's a system group
-    if getent group nobody >/dev/null; then
-        delgroup --system nobody || true
-    fi
+# Automatically added by dh_installsysusers/13.11.4
+if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
+   systemd-sysusers ${DPKG_ROOT:+--root="$DPKG_ROOT"} basic.conf systemd-journal.conf systemd-network.conf
 fi
-
-# Automatically added by dh_installinit/12.1.1
+# End automatically added section
+# Automatically added by dh_installtmpfiles/13.11.4
 if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
-	# In case this system is running systemd, we need to ensure that all
-	# necessary tmpfiles (if any) are created before starting.
-	if [ -d /run/systemd/system ] ; then
-		systemd-tmpfiles --create debian.conf home.conf journal-nocow.conf legacy.conf systemd-nologin.conf systemd.conf tmp.conf var.conf x11.conf >/dev/null || true
+	if [ -x "$(command -v systemd-tmpfiles)" ]; then
+		systemd-tmpfiles ${DPKG_ROOT:+--root="$DPKG_ROOT"} --create debian.conf home.conf journal-nocow.conf legacy.conf provision.conf systemd-network.conf systemd-nologin.conf systemd-pstore.conf systemd-tmp.conf systemd.conf tmp.conf var.conf x11.conf >/dev/null || true
 	fi
 fi
 # End automatically added section
-# Automatically added by dh_installdeb/12.1.1
-dpkg-maintscript-helper rm_conffile /etc/X11/xinit/xinitrc.d/50-systemd-user.sh 228-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/systemd/bootchart.conf 230-1\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.hostname1.conf 233-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.locale1.conf 233-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.login1.conf 233-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.machine1.conf 228-5\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.network1.conf 233-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.resolve1.conf 233-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.systemd1.conf 233-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.timedate1.conf 233-3\~ -- "$@"
-dpkg-maintscript-helper rm_conffile /etc/dbus-1/system.d/org.freedesktop.systemd-shim.conf 239-15\~ systemd-shim -- "$@"
+# Automatically added by dh_installdeb/13.11.4
+dpkg-maintscript-helper rm_conffile /etc/dhcp/dhclient-exit-hooks.d/timesyncd 245.4-2\~ -- "$@"
+dpkg-maintscript-helper rm_conffile /etc/systemd/timesyncd.conf 245.4-2\~ -- "$@"
+dpkg-maintscript-helper rm_conffile /etc/pam.d/systemd-user 247\~rc2-3\~ -- "$@"
+dpkg-maintscript-helper rm_conffile /etc/systemd/resolved.conf 251.3-2\~ -- "$@"
 # End automatically added section
 
+
+if [ -n "$2" ]; then
+    _systemctl daemon-reexec || true
+    # do not restart logind
+    # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=919509
+    if dpkg --compare-versions "$2" lt-nl "246.2-2~"; then
+        # the socket configuration changed
+        _systemctl stop systemd-networkd.socket || true
+    fi
+    _systemctl try-restart systemd-networkd.service || true
+    _systemctl try-restart systemd-journald.service || true
+fi
